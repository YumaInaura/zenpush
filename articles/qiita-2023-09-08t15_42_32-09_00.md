---
title: "AWS Lambda ( Node.js 18.x ) ã§ AWS System Manager (SSM) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®Secure"
emoji: "ğŸ–¥"
type: "tech"
topics: ["Node.js", "AWS", "lambda"]
published: true
published_at: 2023-09-15 19:00
---

# å…¬å¼

https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/ps-integration-lambda-extensions.html


# SSM ( AWS Systems Manager ) ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãŠã

ã“ã“ã§ã¯

```
testparam
```
ã¨ã„ã†ã‚­ãƒ¼åã§ç™»éŒ²ã™ã‚‹

# Lambdaé–¢æ•°ã‚’ä½œæˆã™ã‚‹

AWSä¸Šã®localhostã®å›ºå®šã®ãƒãƒ¼ãƒˆã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã„ã†ä»•çµ„ã¿ã®ã‚ˆã†ã 

- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦SSMã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’æ¸¡ã™ `name=testparam` 
- ç§˜å¯†å€¤ã®Decryptã®ãŸã‚ã« `withDecryption=true` ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã« `AWS_SESSION_TOKEN` ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒ
ã“ã‚Œã¯Lambdaå®Ÿè¡Œã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°ã®ã‚ˆã†ã 
ãªã®ã§è‡ªåˆ†ã§ä½•ã‹ã‚’è¨­å®šã™ã‚‹å¿…è¦ã¯ãªã„

## ã‚³ãƒ¼ãƒ‰ä¾‹

`index.mjs`

```js
export const handler = async (event) => {
  console.log("START");

  const response = await fetch(
    "http://localhost:2773/systemsmanager/parameters/get?name=testparam&withDecryption=true",
    {
      headers: {
      "X-Aws-Parameters-Secrets-Token": process.env.AWS_SESSION_TOKEN,
      }
    }
  )
  const json = await response.json()
  console.log("VALUE IS ...")
  console.log(json["Parameter"]["Value"])
};

```

# å®Ÿè¡Œæ¨©é™ã®ä»˜ä¸

Lambdaå®Ÿè¡Œã®æ¨©é™ã«ä»¥ä¸‹ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

- ssm:GetParameter â€” Parameter Store ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—ã«å¿…è¦
- kms:Decrypt â€” Parameter Store ã‹ã‚‰ SecureString ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦

Lambdaã®å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã¯ Lambdaé–¢æ•°ã® è¨­å®š > ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‹ã‚‰ç¢ºèªã§ãã‚‹ã®ã§ã“ã®ãƒ­ãƒ¼ãƒ«ã«æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹


ä»¥ä¸‹ã¯Lambdaé–¢æ•°ã‚’ä½œæˆã—ãŸæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¨©é™ã« ssm / ksm ã®æ¨©é™ã‚’ä»˜ä¸ã—ãŸã‚‚ã®

```json
{
	"Statement": [
		{
			"Action": [
				"logs:CreateLogGroup"
			],
			"Effect": "Allow",
			"Resource": "arn:aws:logs:<REGION>:<ACCOUNT_ID>:*"
		},
		{
			"Action": [
				"ssm:GetParameter"
			],
			"Effect": "Allow",
			"Resource": "arn:aws:ssm:<REGION>:<ACCOUNT_ID>:*"
		},
		{
			"Action": [
				"kms:Decrypt",
				"kms:*"
			],
			"Effect": "Allow",
			"Resource": "arn:aws:ksm:<REGION>:<ACCOUNT_ID>:*"
		},
		{
			"Action": [
				"logs:CreateLogStream",
				"logs:PutLogEvents"
			],
			"Effect": "Allow",
			"Resource": [
				"arn:aws:logs:<REGION>:<ACCOUNT_ID>:log-group:/aws/lambda/<LAMBDA_NAME>:*"
			]
		}
	],
	"Version": "2012-10-17"
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚­ãƒ¼å˜ä½ã§æ¨©é™ã‚’çµã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ãªã®ã§å¿…è¦ãªã‚‰ã°ãã†ã™ã‚‹

# Lambdaé–¢æ•°ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã™ã‚‹

ã“ã®æ©Ÿèƒ½ã¯æ‹¡å¼µãªã®ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãŒå¿…è¦ã®ã‚ˆã†ã 

<img width="804" alt="image" src="https://github.com/YumaInaura/YumaInaura/assets/13635059/60b2474e-70c3-4389-a5c8-6037b3b65d2e">

# å®Ÿè¡Œä¾‹

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªJSONãŒå¾—ã‚‰ã‚Œã‚‹ã®ã§ã“ã‚Œã‚’parseã—ã¦åˆ©ç”¨ã™ã‚Œã°OK
`["Parameter"]["Value"]` ã«å€¤ãŒå…¥ã£ã¦ã„ã‚‹

```json
{
  "Parameter": {
    "ARN": "arn:aws:ssm:<REGION>:<ACCOUNT_ID>:parameter/testparam",
    "DataType": "text",
    "LastModifiedDate": "2023-09-08T04:07:03.546Z",
    "Name": "testparam",
    "Selector": null,
    "SourceResult": null,
    "Type": "SecureString",
    "Value": "xxx",
    "Version": 1
  },
  "ResultMetadata": {}
}
```

# å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼

## bad session token or header key

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã®SESSION_KEYãŒé–“é•ã£ã¦ã„ã‚‹

## AccessDeniedException - ssm:GetParameter on resource

Lambdaã®å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«ssm:GetParameterã®æ¨©é™ãŒãªã„å ´åˆã«èµ·ã“ã‚‹

>[AWS Parameters and Secrets Lambda Extension] 2023/09/08 05:01:38 ERROR GetParameter request encountered an error: operation error SSM: GetParameter, https response error StatusCode: 400, RequestID: *********************, api error 
AccessDeniedException: User: arn:aws:sts::***:assumed-role/example-role/xxx is not authorized to perform:ssm:GetParameter on resource: arn:aws:ssm:ap-northeast-1:*********:parameter/testparam because no identity-based policy allows the ssm:GetParameter action

ä»Šå›ã“ã“ã§å°‘ã—ã¯ã¾ã£ãŸ

åŸå› ã¯(å½“ãŸã‚Šå‰ã ãŒ)æ­£ã—ãæ¨©é™ä»˜ä¸ãŒå‡ºæ¥ã¦ã„ãªã‹ã£ãŸã“ã¨ã ã£ãŸ

Lambdaã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒªã‚·ãƒ¼ã« `ssm:GetParameter` ã‚’è¿½åŠ ã—ã‚ˆã†ã¨æ€ã£ã¦ã¤ã„ `"Resource": "arn:aws:logs` ã®æ–¹ã«è¨±å¯ã‚’è¿½åŠ ã—ã¦ã—ã¾ã£ã¦ã„ãŸãŒ
ã“ã¡ã‚‰ã¯logsç”¨ã®ãƒªã‚½ãƒ¼ã‚¹æŒ‡å®šãªã®ã§ ssm ã®è¨±å¯ã‚’ã—ã¦ã‚‚æ„å‘³ãŒãªã‹tgãŸ


```json
{
	"Statement": [
		{
			"Action": [
				"logs:CreateLogGroup",
				"kms:Decrypt",
				"kms:*"
			],
			"Effect": "Allow",
			"Resource": "arn:aws:logs:<REGION>:<ACCOUNT_ID>:*"
		}
	]
}
```

å‰è¿°ã®é€šã‚ŠResource / Action ã‚’æ­£ã—ãæŒ‡å®šã™ã‚‹ã“ã¨ã§å®Ÿè¡Œå¯èƒ½ã«ãªã£ãŸ


# ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼å‹Ÿé›†


ä½•ã‹è³ªå•ã€æ‚©ã¿äº‹ã€ç›¸è«‡ãªã©ã‚ã‚Œã°LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã‚‚ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://line.me/ti/g2/eEPltQ6Tzh3pYAZV8JXKZqc7PJ6L0rpm573dcQ


# Twitter

https://twitter.com/YumaInaura


# å…¬é–‹æ—¥æ™‚

2023-09-08
